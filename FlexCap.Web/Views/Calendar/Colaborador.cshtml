@model IEnumerable<FlexCap.Web.Models.Calendar.CalendarModel>
@{
    ViewData["Title"] = "Colaborador Calendar";
    Layout = "~/Views/Shared/Template.cshtml";
}

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

 <style>
                                               COMPLETA DO RH.CSHTML/MANAGER.CSHTML AQUI)
                                               }
                                               }

                                               <style >
                                               /* Layout principal */
                                               #calendar {
                                                   margin-bottom: 1rem;
                                                   width: 100%;
                                               }

                                               /* Alinhamento à esquerda */
                                               .fc {
                                                   text-align: left;
                                               }

                                               /* Responsividade geral */
                                               @@media (max-width: 768px) {
                                                   #calendar {
                                                       font-size: 0.7rem;
                                                   }

                                                   .fc-toolbar-title {
                                                       font-size: 1rem;
                                                   }

                                                   .fc .fc-daygrid-day-number {
                                                       font-size: 0.6rem;
                                                   }

                                                   .fc .fc-col-header-cell {
                                                       font-size: 0.6rem;
                                                   }

                                                   #monthEventsCard {
                                                       margin-top: 1rem;
                                                   }
                                               }

                                               /* Cabeçalho compacto */
                                               .fc-header-toolbar {
                                                   padding: 0;
                                                   margin-bottom: 0 !important;
                                                   font-size: 0.8rem;
                                               }

                                               /* Altura das células */
                                               .fc .fc-daygrid-day-frame {
                                                   min-height: 10px;
                                                   height: 100% !important;
                                               }

                                               /* Números dos dias */
                                               .fc .fc-daygrid-day-number {
                                                   font-size: 0.65rem;
                                                   padding: 2px;
                                                   margin: 0;
                                               }

                                               /* Cabeçalho dos dias (Sun, Mon...) */
                                               .fc .fc-col-header-cell {
                                                   font-size: 0.7rem;
                                                   padding: 2px 0;
                                               }

                                               /* Compactar eventos */
                                               .fc-daygrid-event-dot {
                                                   width: 5px;
                                                   height: 5px;
                                                   margin: 0 2px;
                                               }

                                               .fc-daygrid-event {
                                                   padding: 0 !important;
                                                   font-size: 0.65rem;
                                               }

                                               /* Lista lateral de eventos do mês */
                                               #monthEventsCard {
                                                   font-size: 0.75rem;
                                                   border-radius: 0.5rem;
                                               }

                                                   #monthEventsCard h6 {
                                                       font-weight: 600;
                                                       font-size: 0.9rem;
                                                   }

                                               #eventList {
                                                   max-height: 300px;
                                                   overflow-y: auto;
                                               }

                                               /* Cores de eventos */
                                               .badge-color-box {
                                                   display: inline-block;
                                                   width: 10px;
                                                   height: 10px;
                                                   border-radius: 2px;
                                                   margin-right: 4px;
                                                   vertical-align: middle;
                                               }
</style>

<div class="py-4 container-fluid">
    <h3 class="fw-bold mb-4 text-start">Employee Calendar</h3>

    <div class="row align-items-start">
        <div class="col-12 col-lg-8">
            <div class="border rounded p-4 shadow-sm bg-white" style="max-width: 600px;">
                <div class="d-flex justify-content-start align-items-center mb-3 gap-3">
                    <div class="form-group">
                        <label for="month-filter" class="visually-hidden">Month</label>
                        <select id="month-filter" class="form-select"></select>
                    </div>
                    <div class="form-group">
                        <label for="year-filter" class="visually-hidden">Year</label>
                        <select id="year-filter" class="form-select"></select>
                    </div>
                </div>

                <div id="calendar"></div>
            </div>
        </div>

        <div class="col-12 col-lg-4 mt-4 mt-lg-0">
            <div class="border rounded p-3 shadow-sm bg-light h-100" id="monthEventsCard">
                <h6 class="fw-bold mb-3 text-start">Events in <span id="currentMonthName">This Month</span>:</h6>
                <ul id="eventList" class="list-unstyled small mb-0">
                    <li class="text-muted">Loading events...</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    // Variável global para ser acessível
    let calendarInstance;

    document.addEventListener('DOMContentLoaded', async function () {
        const calendarEl = document.getElementById('calendar');
        const eventListEl = document.getElementById('eventList');
        const monthFilter = document.getElementById('month-filter');
        const yearFilter = document.getElementById('year-filter');
        const currentMonthNameEl = document.getElementById('currentMonthName');


        function showError(msg, err) {
            console.error(msg, err);
            alert('Error processing request. See console for details.');
        }

        // --- Funções Auxiliares (COPIADAS DO MANAGER/RH) ---

        function getColorByType(type) {
            switch (type) {
                case 'Holiday (Brazil)': return '#28a745';
                case 'Holiday (EUA)':
                case 'Holiday (USA)': return '#dc3545';
                case 'Corporate Training': return '#ffc107';
                case 'Online Event': return '#0d6efd';
                default: return '#6c757d';
            }
        }

        // --- Inicialização do Calendário e Carregamento de Dados ---

        async function loadAndRenderEvents(month, year) {
            let events = [];
            try {
                // Chama o mesmo endpoint do Controller: /Calendar/GetEvents
                const url = `/Calendar/GetEvents`;
                const resp = await fetch(url);
                if (!resp.ok) throw new Error('GET /Calendar/GetEvents returned ' + resp.status);
                events = await resp.json();
            } catch (err) {
                showError('Error fetching events from server.', err);
                events = [];
            }

            const fcEvents = (events || []).map(e => ({
                id: e.id,
                title: e.title,
                start: e.date,
                color: e.color,
                extendedProps: { type: e.type }
            }));

            if (!calendarInstance) {
                // Inicializa FullCalendar na primeira carga
                calendarInstance = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    height: 'auto',
                    expandRows: false,
                    selectable: false, // Não permite seleção
                    displayEventTime: false,
                    headerToolbar: {
                        left: 'prev,next',
                        center: 'title',
                        right: ''
                    },
                    events: fcEvents,

                    datesSet: function (info) {
                        const currentMonth = info.view.currentStart.getMonth() + 1;
                        const currentYear = info.view.currentStart.getFullYear();

                        monthFilter.value = currentMonth;
                        yearFilter.value = currentYear;

                        renderEventList();
                    },
                });
                calendarInstance.render();
            } else {
                calendarInstance.setOption('events', fcEvents);
                calendarInstance.gotoDate(new Date(year, month - 1, 1));
            }

            renderEventList();
        }

        // Função para renderizar a lista lateral de eventos do mês atual
        function renderEventList() {
            if (!calendarInstance) return;

            const events = calendarInstance.getEvents();
            const viewStart = calendarInstance.view.currentStart;
            const month = viewStart.getMonth();
            const year = viewStart.getFullYear();

            if (currentMonthNameEl) {
                currentMonthNameEl.textContent = viewStart.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            }

            const monthEvents = events.filter(e => {
                const start = e.start;
                return start.getFullYear() === year && start.getMonth() === month;
            }).sort((a, b) => a.start - b.start);

            eventListEl.innerHTML = ""; // Limpa a lista

            if (monthEvents.length === 0) {
                eventListEl.innerHTML = '<li class="list-group-item text-muted small">No events this month.</li>';
                return;
            }

            monthEvents.forEach(e => {
                const type = e.extendedProps.type || 'N/A';
                const color = e.backgroundColor || e.color || getColorByType(type);
                const dateStr = e.start.toLocaleDateString("en-US", { month: "short", day: "numeric" });

                const li = document.createElement("li");
                li.className = "d-flex align-items-center mb-1 pb-1 border-bottom";
                li.innerHTML = `
                    <span class="d-flex align-items-center gap-2 flex-grow-1">
                        <span class="badge-color-box" style="background:${color}"></span>
                        ${e.title}
                    </span>
                    <small class="text-muted">${dateStr} (${type})</small>`;

                eventListEl.appendChild(li);
            });

            // Lógica de deleção removida
        }

        // --- Lógica dos Filtros ---
        function initializeFilters() {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1;

            const months = [
                { value: 1, text: 'January' }, { value: 2, text: 'February' },
                { value: 3, text: 'March' }, { value: 4, text: 'April' },
                { value: 5, text: 'May' }, { value: 6, text: 'June' },
                { value: 7, text: 'July' }, { value: 8, text: 'August' },
                { value: 9, text: 'September' }, { value: 10, text: 'October' },
                { value: 11, text: 'November' }, { value: 12, text: 'December' }
            ];

            months.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.value;
                opt.textContent = m.text;
                monthFilter.appendChild(opt);
            });

            for (let i = currentYear - 5; i <= currentYear + 5; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = i;
                yearFilter.appendChild(opt);
            }

            monthFilter.value = currentMonth;
            yearFilter.value = currentYear;

            // LISTENERS PARA FILTROS: move o calendário para a data selecionada
            monthFilter.addEventListener('change', () => {
                const selectedMonth = monthFilter.value;
                const selectedYear = yearFilter.value;
                calendarInstance.gotoDate(new Date(selectedYear, selectedMonth - 1, 1));
            });
            yearFilter.addEventListener('change', () => {
                const selectedMonth = monthFilter.value;
                const selectedYear = yearFilter.value;
                calendarInstance.gotoDate(new Date(selectedYear, selectedMonth - 1, 1));
            });
        }

        initializeFilters();
        loadAndRenderEvents(monthFilter.value, yearFilter.value); // Primeira carga de dados
    });
</script>