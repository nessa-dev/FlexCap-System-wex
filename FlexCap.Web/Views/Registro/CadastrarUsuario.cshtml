@model FlexCap.Web.Models.ColaboradorViewModel

@{
    ViewData["Title"] = Model.Id > 0 ? "Edit Employee: " + Model.FullName : "Register New Employee";
    Layout = "~/Views/Shared/Template.cshtml";

    var defaultPhotoUrl = "https://placehold.co/100x100/F5F5F5/B0B0B0?text=Photo";
    var currentStatus = Model.Status ?? "Ativo";

    var inactivityReasonsList = ViewBag.InactivityReasons as SelectList;
}

<style>
    .form-control, .form-select {
        margin-bottom: 0 !important;
        height: 1.8rem !important;
        padding: 0.2rem 0.5rem !important;
        font-size: 0.85rem;
    }

    .form-label, .form-check-label {
        font-size: 0.85rem !important;
        margin-bottom: 0.2rem !important;
    }

    .compact-row {
        margin-bottom: 0.5rem !important;
    }

    .field-validation-error {
        font-size: 0.75rem;
    }
</style>

<div class="py-4" style="max-width: 900px; width: 100%; margin: 0 auto;">
    <div style="max-height: calc(100vh - 150px); overflow-y: auto;">

        <a asp-controller="Colaboradores" asp-action="Listar" class="btn btn-sm btn-outline-secondary mb-3">
            <span class="material-icons" style="font-size: 16px;">arrow_back</span> Back to List
        </a>

        <h3 class="fw-bold mb-3">@ViewData["Title"]</h3>

        <div class="p-3 border rounded shadow-sm">
            <form asp-controller="Registro" asp-action="@(Model.Id > 0 ? "SalvarEdicao" : "NovoColaborador")" method="post" enctype="multipart/form-data">

                @if (Model.Id > 0)
                {
                    @Html.HiddenFor(m => m.Id)
                }

                <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                <div class="row g-2 align-items-start">

                    <div class="col-md-3 text-center d-flex flex-column align-items-center">
                        <img id="photo-preview" src="@(Model.PhotoUrl ?? defaultPhotoUrl)"
                             class="rounded-circle border shadow-sm mb-2"
                             style="width: 100px; height: 100px; object-fit: cover;" alt="Employee Photo">

                        <input type="file" id="photoFile" name="PhotoFile" accept="image/*" class="form-control form-control-sm mb-2" />

                        @Html.HiddenFor(m => m.PhotoUrl)
                    </div>

                    <div class="col-md-9">
                        <div class="row g-2">

                            <div class="col-md-6 compact-row">
                                <label class="form-label small">Full Name</label>
                                <input asp-for="FullName" class="form-control" />
                                <span asp-validation-for="FullName" class="text-danger small"></span>
                            </div>

                            <div class="col-md-6 compact-row">
                                <label class="form-label small">Email</label>
                                <input asp-for="Email" class="form-control" />
                                <span asp-validation-for="Email" class="text-danger small"></span>
                            </div>

                            <div class="col-md-6 compact-row">
                                <label class="form-label small">Password</label>
                                <input asp-for="Senha" type="password" class="form-control" placeholder="@(Model.Id > 0 ? "Leave blank to keep current password" : "")" />
                                <span asp-validation-for="Senha" class="text-danger small"></span>
                            </div>

                            <div class="col-md-6 compact-row">
                                <label class="form-label small">Position</label>
                                <select asp-for="Position" asp-items="ViewBag.Positions" class="form-select"></select>
                                <span asp-validation-for="Position" class="text-danger small"></span>
                            </div>

                            <div class="col-md-4 compact-row">
                                <label class="form-label small">Department</label>
                                <select asp-for="Department" asp-items="ViewBag.Departments" class="form-select"></select>
                                <span asp-validation-for="Department" class="text-danger small"></span>
                            </div>

                            <div class="col-md-4 compact-row">
                                <label class="form-label small">Team</label>
                                <select asp-for="TeamName" asp-items="ViewBag.Teams" class="form-select"></select>
                                <span asp-validation-for="TeamName" class="text-danger small"></span>
                            </div>

                            <div class="col-md-4 compact-row">
                                <label class="form-label small">Country</label>
                                <select asp-for="Country" asp-items="ViewBag.Countries" class="form-select"></select>
                                <span asp-validation-for="Country" class="text-danger small"></span>
                            </div>

                            <div class="col-md-12 compact-row mt-2 pt-1">
                                <label class="form-label d-block small mb-1">Status</label>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="Status" id="status-ativo" value="Ativo" checked="@("Ativo".Equals(currentStatus))">
                                    <label class="form-check-label small" for="status-ativo">Ativo</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="Status" id="status-inativo" value="Inativo" checked="@("Inativo".Equals(currentStatus))">
                                    <label class="form-check-label small" for="status-inativo">Inativo</label>
                                </div>
                                <span asp-validation-for="Status" class="text-danger small d-block"></span>
                            </div>

                        </div>
                    </div>
                </div>

                <div id="inactivity-fields-group" class="col-md-12" style="display: none;">
                    <hr class="my-2" />
                    <div class="row g-2">
                        <div class="col-md-4 compact-row">
                            <label class="form-label small">Reason for Inactivity</label>
                            <select asp-for="InactivityReason" asp-items="ViewBag.InactivityReasons" class="form-select form-select-sm">
                                <option value="">Select Reason</option>
                            </select>
                            <span asp-validation-for="InactivityReason" class="text-danger small"></span>
                        </div>
                        <div class="col-md-4 compact-row">
                            <label class="form-label small">Start Date</label>
                            <input asp-for="StartDate" type="date" class="form-control form-control-sm" />
                            <span asp-validation-for="StartDate" class="text-danger small"></span>
                        </div>
                        <div class="col-md-4 compact-row">
                            <label class="form-label small">End Date</label>
                            <input asp-for="EndDate" type="date" class="form-control form-control-sm" />
                            <span asp-validation-for="EndDate" class="text-danger small"></span>
                        </div>
                    </div>
                </div>

                @Html.HiddenFor(m => m.Status)


                <div class="mt-2 d-flex justify-content-end gap-2">
                    <a asp-controller="Colaboradores" asp-action="Listar" class="btn btn-secondary px-4">Cancel</a>
                    <button type="submit" class="btn btn-custom px-4">Save</button>
                </div>

            </form>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const photoFileInput = document.getElementById('photoFile');
            const preview = document.getElementById('photo-preview');
            const defaultPlaceholder = '@defaultPhotoUrl';

            photoFileInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        preview.src = ev.target.result;
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.src = defaultPlaceholder;
                }
            });

            const inactiveGroup = document.getElementById('inactivity-fields-group');
            const radioAtivo = document.getElementById('status-ativo');
            const radioInativo = document.getElementById('status-inativo');

            function toggleInactivityFields() {
                 inactiveGroup.style.display = radioInativo.checked ? 'block' : 'none';
                 if (radioAtivo.checked) {
                     document.getElementById('InactivityReason').value = '';
                     document.getElementById('StartDate').value = '';
                     document.getElementById('EndDate').value = '';
                 }
            }

            radioAtivo.addEventListener('change', toggleInactivityFields);
            radioInativo.addEventListener('change', toggleInactivityFields);
            toggleInactivityFields();
        });
    </script>
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}