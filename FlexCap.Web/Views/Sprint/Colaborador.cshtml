@{
    ViewData["Title"] = "Sprints";
    Layout = "~/Views/Shared/Template.cshtml";
}

<style>
    #gantt-chart-container {
        border: 1px solid #ccc;
        background-color: #fff;
    }

    .gantt-row-header {
        font-weight: 600;
        background-color: #f8f9fa;
        color: #495057;
        text-align: center;
    }

    .gantt-month-row {
        display: flex;
        border-bottom: 1px solid #dee2e6;
    }

    .gantt-day-row {
        display: flex;
    }

    .gantt-cell {
        border-right: 1px solid #eee;
        border-bottom: 1px solid #eee;
        text-align: center;
        padding: 4px 0;
        font-size: 0.8rem;
        min-width: 25px;
    }

    .gantt-body {
        position: relative;
        background-color: #ffffff;
        border-left: 1px solid #dee2e6;
        border-bottom: 1px solid #dee2e6;
    }

    .gantt-bar {
        position: absolute;
        height: 35px;
        border-radius: 6px;
        color: #fff;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        cursor: default;
    }

    .sprint-bar {
        background-color: #0d6efd;
    }

    .gantt-tooltip {
        position: absolute;
        padding: 6px 10px;
        background-color: #fff6da;
        border: 1px solid #f9d774;
        border-radius: 6px;
        font-size: 0.75rem;
        white-space: nowrap;
        pointer-events: none;
        z-index: 50;
        transform: translate(-50%, -120%);
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
</style>

<div class="py-4 w-100" style="max-width: 900px; margin-left: 0.5rem; margin-right: auto;">

    <h3 class="fw-bold mb-3">@ViewData["Title"]</h3>

    <div id="impactNotificationsContainer" class="mb-4"></div>

    <div id="loadingStatus" class="alert alert-info text-center">
        Checking your participation in the active sprint...
    </div>

    <div id="restrictedContent" class="d-none">


        <!-- HEADER DA SPRINT ATIVA E BOTÃO DE DETALHES -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="fw-bold mb-0">Active Sprint Progress</h4>
            <button id="viewDetailsBtn" class="btn btn-outline-info btn-sm fw-semibold" disabled
                    data-bs-toggle="modal" data-bs-target="#sprintDetailsModal">
                View Sprint Details
            </button>
        </div>

                        <!-- GANTT -->
        <div class="border rounded p-3 shadow-sm bg-white overflow-x-auto mb-5">
            <div id="gantt-chart-container" class="position-relative" style="min-width: 850px;">
                <div id="gantt-header" class="gantt-row-header d-flex flex-column border-bottom"></div>
                <div id="gantt-body" class="gantt-body position-relative" style="height: 250px;"></div>
            </div>
        </div>

        <h4 class="fw-bold mb-3">Team Sprint History</h4>
        <div id="finishedSprintsContainer" class="d-grid gap-2"></div>
        <!-- VIEW ALL BUTTON -->
        <div id="viewAllSprintsWrapper" class="text-center d-none mt-3">
            <button class="btn btn-outline-success"
                    data-bs-toggle="modal"
                    data-bs-target="#allSprintsModal">
                View all sprints
            </button>
        </div>

        <div id="historyLoading" class="d-none">Loading history...</div>
        <div id="historyErrorContainer" class="d-none alert alert-danger"></div>
        <div id="historyEmptyMessage" class="d-none text-muted"></div>


    </div>

    <div id="accessDeniedMessage" class="d-none">
        <div class="alert alert-warning">
            There is no active sprint, or you are not listed as a participant.
        </div>
    </div>
</div>

<!-- MODAL — ALL FINISHED SPRINTS -->
<div class="modal fade" id="allSprintsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title fw-bold">All Finished Sprints</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div id="allSprintsList" class="d-grid gap-2"></div>
            </div>

        </div>
    </div>
</div>

<!-- MODAL — SPRINT DETAILS  -->

<div class="modal fade" id="sprintDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 id="detailTitle" class="modal-title fw-bold">Sprint Details</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <p class="text-muted mb-1" id="detailDates">Duration: Loading...</p>
                <hr>
                <h6 class="fw-bold">Goal</h6>
                <p id="detailGoal">—</p>
                <h6 class="fw-bold">Notes</h6>
                <p id="detailNotes">—</p>
            </div>
        </div>
    </div>
</div>


@section Scripts {

    <script src="~/js/sprint-gantt.js"></script>

    <script>


        let activeSprintDetails = null;

         function formatDate(dateStr) {
             if (!dateStr) return 'N/A';
             return new Date(dateStr).toLocaleDateString("en-US", {
                 month: "short",
                 day: "numeric",
                 year: "numeric"
             });
         }

         // Função para preencher e exibir o modal de detalhes da SPRINT ATIVA
         function displayActiveSprintDetails() {
             if (!activeSprintDetails) {
                 return alert("Active sprint details not loaded.");
             }

             // Preenche o modal (focando no plano da sprint ativa)
             document.getElementById("detailTitle").textContent = activeSprintDetails.name || 'Active Sprint';
             document.getElementById("detailDates").textContent = `Duration: ${formatDate(activeSprintDetails.startDate)} - ${formatDate(activeSprintDetails.endDate)}`;

             document.getElementById("detailGoal").textContent = activeSprintDetails.goal || 'No goal set.';
             document.getElementById("detailNotes").textContent = activeSprintDetails.notes || 'No notes available.';

             // Abre o modal
             new bootstrap.Modal(document.getElementById("sprintDetailsModal")).show();
         }

         document.addEventListener('DOMContentLoaded', async () => {

             const loadingEl = document.getElementById('loadingStatus');
             const restrictedContentEl = document.getElementById('restrictedContent');
             const deniedMessageEl = document.getElementById('accessDeniedMessage');
             const viewDetailsBtn = document.getElementById('viewDetailsBtn'); 

             loadingEl.classList.remove('d-none');
             restrictedContentEl.classList.add('d-none');
             deniedMessageEl.classList.add('d-none');
             viewDetailsBtn.disabled = true; 

             try {
                 // 1. CHAMA O ENDPOINT PRINCIPAL (Participação)
                 const response = await fetch('/Sprint/IsParticipatingAndGetTeamData');

                 if (!response.ok) {
                     throw new Error('API Failed to respond with status ' + response.status);
                 }

                 const data = await response.json();

                 loadingEl.classList.add('d-none');

                 if (data.isParticipating === true) {

                     restrictedContentEl.classList.remove('d-none');

                     // 2. BUSCA DETALHES COMPLETOS DA SPRINT ATIVA (Precisa do Goal/Notes)
                     const detailsResponse = await fetch(`/Sprint/GetActive?id=${data.sprintId}`);

                     if (!detailsResponse.ok) {
                         // Se falhar, registra o erro, mas continua com Gantt/Histórico
                         console.error('Failed to fetch detailed sprint plan.');
                         activeSprintDetails = null;
                     } else {
                         // Armazena os detalhes completos para o modal
                         activeSprintDetails = await detailsResponse.json();

                         // 3. ATIVA BOTÃO DE DETALHES e anexa a função
                         viewDetailsBtn.disabled = false;
                         viewDetailsBtn.addEventListener('click', displayActiveSprintDetails);
                     }

                     // 4. CARREGA GANTT (função global)
                     if (typeof loadGanttData === 'function') {
                         loadGanttData(data.sprintId, true);
                     }

                     // 5. CARREGA HISTÓRICO (função global)
                     if (typeof loadSprintHistory === 'function') {
                         loadSprintHistory();
                     }

                 } else {
                     deniedMessageEl.classList.remove('d-none');
                 }

             } catch (error) {
                 console.error('AJAX/Execution Error:', error);

                 loadingEl.classList.add('d-none');

                 deniedMessageEl.innerHTML =
                     `<div class="alert alert-danger">Error verifying sprint status.</div>`;
                 deniedMessageEl.classList.remove('d-none');
             }
         });
    </script>
}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">