@{
    ViewData["Title"] = "Sprint e Gantt";
    Layout = "~/Views/Shared/Template.cshtml";
}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
    /* Estilos do Gantt  */
    #gantt-chart-container {
        border: 1px solid #ccc;
        background-color: #fff;
    }

    .gantt-row-header {
        font-weight: 600;
        background-color: #f8f9fa;
        color: #495057;
        text-align: center;
    }

    .gantt-month-row, .gantt-day-row {
        display: flex;
    }

    .gantt-month-row {
        border-bottom: 1px solid #dee2e6;
    }

    .gantt-cell {
        border-right: 1px solid #eee;
        border-bottom: 1px solid #eee;
        text-align: center;
        padding: 4px 0;
        font-size: 0.8rem;
        min-width: 25px;
    }

    .gantt-body {
        position: relative;
        background-color: #ffffff;
        border-left: 1px solid #dee2e6;
        border-bottom: 1px solid #dee2e6;
    }

    .gantt-bar {
        position: absolute;
        height: 35px;
        border-radius: 6px;
        color: #fff;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        cursor: default; 
    }

    .sprint-bar {
        background-color: #0d6efd;
    }
</style>


<div class="py-4" style="max-width: 950px; width: 100%; margin-left: 0.5rem; margin-right: auto; height: 100%;">

    <h3 class="fw-bold mb-4">@ViewData["Title"]</h3>

    <!-- FILTRO POR EQUIPE -->
    <div class="d-flex align-items-center gap-3 mb-4 p-3 border rounded shadow-sm bg-white">
        <label for="teamSelector" class="form-label mb-0 fw-semibold">View Team Sprint:</label>
        <select id="teamSelector" class="form-select form-select-sm" style="max-width: 300px;">
            <option value="" disabled selected>Loading teams...</option>
        </select>
        <button id="detailsButton" class="btn btn-outline-info btn-sm fw-semibold" disabled data-bs-toggle="modal" data-bs-target="#sprintDetailsModal">
            More Details
        </button>
    </div>

    <!-- GANTT CHART  -->
    <div id="ganttArea" class="p-3 border rounded shadow-sm bg-white overflow-x-auto">

        <h4 id="ganttTitle" class="fw-bold mb-3 text-muted">Select a team above.</h4>

        <div id="ganttStatus" class="alert alert-secondary text-center">Awaiting team selection.</div>

        <div id="ganttDisplay" class="d-none">
            <div id="gantt-chart-container" class="position-relative" style="min-width: 800px;">
                <div id="gantt-header" class="gantt-row-header d-flex flex-column border-bottom"></div>
                <div id="gantt-body" class="gantt-body position-relative" style="height: 250px;"></div>
            </div>
        </div>

    </div>

</div>

<!-- Sprint Details Modal  -->
<div class="modal fade" id="sprintDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content p-4">
            <div class="modal-header border-0">
                <h4 class="modal-title fw-bold" id="detailTitle"></h4>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <p class="text-muted" id="detailDates"></p>
            <div class="modal-body">
                <h6 class="fw-bold">Sprint Goal</h6>
                <p id="detailGoal"></p>
                <h6 class="fw-bold">Notes</h6>
                <p id="detailNotes"></p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/sprint-gantt.js"></script>
    <script>
        let currentActiveSprintId = null; 

        document.addEventListener('DOMContentLoaded', async () => {
            const teamSelector = document.getElementById('teamSelector');
            const ganttStatus = document.getElementById('ganttStatus');
            const ganttDisplay = document.getElementById('ganttDisplay');
            const ganttTitle = document.getElementById('ganttTitle');
            const detailsButton = document.getElementById('detailsButton');

            const setStatus = (message, alertClass = 'alert-secondary') => {
                ganttStatus.className = `alert ${alertClass} text-center`;
                ganttStatus.textContent = message;
                ganttStatus.classList.remove('d-none');
                ganttDisplay.classList.add('d-none');
                detailsButton.disabled = true;
                ganttTitle.textContent = "Sprint Summary"; 
            };

            try {
                const teamResponse = await fetch('/Sprint/GetAllTeams');
                if (!teamResponse.ok) throw new Error('Failed to load teams.');

                const teams = await teamResponse.json();

                teamSelector.innerHTML = '<option value="" disabled selected>Select a Team</option>';
                teams.forEach(team => {
                    teamSelector.innerHTML += `<option value="${team.teamName}">${team.teamName}</option>`;
                });
            } catch (error) {
                setStatus('Error loading team list.', 'alert-danger');
                return;
            }

            teamSelector.addEventListener('change', async (e) => {
                const selectedTeamName = e.target.value;
                if (!selectedTeamName) return;

                setStatus(`Searching for active sprint for ${selectedTeamName}...`, 'alert-info');

                try {
                    const sprintResponse = await fetch(`/Sprint/GetActiveSprintByTeam?teamName=${selectedTeamName}`);

                    if (sprintResponse.status === 404) {
                        setStatus(`No active sprint found for team: ${selectedTeamName}`, 'alert-warning');
                        currentActiveSprintId = null;
                        return;
                    }
                    if (!sprintResponse.ok) throw new Error('API communication failed.');

                    const sprint = await sprintResponse.json();

                    currentActiveSprintId = sprint.id;

                    if (typeof loadGanttData === 'function') {
                        loadGanttData(sprint.id, true);
                    }

                    ganttStatus.classList.add('d-none');
                    ganttDisplay.classList.remove('d-none');
                    ganttTitle.textContent = `Active Sprint Progress: ${sprint.name}`;
                    detailsButton.disabled = false;

                    // Armazena detalhes para o modal
                    detailsButton.dataset.sprint = JSON.stringify({
                        name: sprint.name,
                        startDate: sprint.startDate,
                        endDate: sprint.endDate,
                        goal: sprint.goal,
                        notes: sprint.notes || 'No notes provided.',
                    });


                } catch (error) {
                    console.error('Error fetching sprint by team:', error);
                    setStatus('Error fetching the sprint. Please try again.', 'alert-danger');
                }
            });

            detailsButton.addEventListener('click', () => {
                try {
                    const sprint = JSON.parse(detailsButton.dataset.sprint);

                    document.getElementById("detailTitle").textContent = sprint.name;
                    document.getElementById("detailDates").textContent = `${new Date(sprint.startDate).toLocaleDateString()} - ${new Date(sprint.endDate).toLocaleDateString()}`;
                    document.getElementById("detailGoal").textContent = sprint.goal;
                    document.getElementById("detailNotes").textContent = sprint.notes;

                } catch (e) {
                    console.error("Error opening sprint details:", e);
                    alert("Could not load sprint details.");
                }
            });
        });
    </script>
}