@using FlexCap.Web.Models.Requests
@using System.Collections.Generic

@model FlexCap.Web.Models.Requests.SubmitViewModelWithHistory

@{
    ViewData["Title"] = "Submit Request";
    Layout = "~/Views/Shared/Template.cshtml";
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <strong>Success!</strong> @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="main-content-fixed py-4">

    <h3 class="fw-bold mb-4">Submit Request</h3>

    <form asp-controller="Request" asp-action="Submit" method="post" enctype="multipart/form-data">

        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

        <div class="mb-3">
            <input asp-for="Subject" type="text" class="form-control" placeholder="Subject" aria-label="Subject">
            <span asp-validation-for="Subject" class="text-danger"></span>
        </div>

        <div class="row g-2 mb-3">
            <div class="col-12 col-sm-4">
                <select asp-for="TypeId" class="form-select" aria-label="Type">
                    <option value="">Select Type</option>
                    <option value="1">Vacation</option>
                    <option value="2">Day Off</option>
                    <option value="3">Personal License</option>
                    <option value="2">Medical Leave</option>
                    <option value="2">Maternity Leave</option>
                    <option value="2">Suspension</option>
                    <option value="2">Other</option>

                </select>
                <span asp-validation-for="TypeId" class="text-danger"></span>
            </div>

            <div class="col-12 col-sm-4">
                <input asp-for="StartDate" type="date" class="form-control" aria-label="Start Date">
                <span asp-validation-for="StartDate" class="text-danger"></span>
            </div>

            <div class="col-12 col-sm-4">
                <input asp-for="EndDate" type="date" class="form-control" aria-label="End date">
                <span asp-validation-for="EndDate" class="text-danger"></span>
            </div>
        </div>

        <div class="mb-3">
            <textarea asp-for="Description" class="form-control" placeholder="Description" rows="4" aria-label="Description"></textarea>
            <span asp-validation-for="Description" class="text-danger"></span>
        </div>

        <div class="mb-3">
            <label for="attach-file" class="btn btn-outline-secondary d-inline-flex align-items-center gap-2 w-auto">
                <i class="bi bi-paperclip"></i>
                Attach File (PDF only)
                <input asp-for="AttachmentFile" type="file" id="attach-file" class="d-none" accept=".pdf" />
            </label>
        </div>

        <div class="d-grid mb-5">
            <button type="submit" class="btn btn-primary btn-lg" formnovalidate>Send Request</button>
        </div>

    </form>

    <hr>

    <h5 class="fw-bold mt-5 mb-3">Requests History</h5>
    <table class="table align-middle">
        <thead>
            <tr>
                <th>Subject</th>
                <th>Submitted On</th>
                <th>Status</th>
                <th>Reason</th>
            </tr>
        </thead>
        <tbody>
            @if (Model.RequestHistory == null || !Model.RequestHistory.Any())
            {
                <tr>
                    <td colspan="4" class="text-center text-muted">No history found for this collaborator.</td>
                </tr>
            }
            else
            {
                @foreach (var item in Model.RequestHistory)
                {
                    string badgeClass = item.CurrentStatus switch
                    {
                        "Approved" => "bg-success",
                        "Rejected" => "bg-danger",
                        "Adjustment Requested" => "bg-info text-dark", // Status de Ajuste/Correção
                        _ => "bg-warning text-dark"
                    };

                    <tr>
                        <td>@item.Subject</td>
                        <td>@item.SubmissionDate.ToShortDateString()</td>
                        <td><span class="badge @badgeClass">@item.CurrentStatus</span></td>

                        <td>
                            @if (item.CurrentStatus == "Rejected" || item.CurrentStatus == "Adjustment Requested")
                            {
                                <button type="button"
                                        class="btn btn-sm btn-outline-secondary"
                                        data-bs-toggle="modal"
                                        data-bs-target="#reasonModal"
                                        data-reason-text="@item.RejectionReason"
                                        title="View Reason">
                                    <i class="bi bi-info-circle"></i> View Reason
                                </button>
                            }
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>

</div>

<div class="modal fade" id="reasonModal" tabindex="-1" aria-labelledby="reasonModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reasonModalLabel">Reason for Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>The following reason was provided by the approver:</p>
                <p id="rejectionReasonText" class="alert alert-secondary"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {

            // LÓGICA PARA CARREGAR A RAZÃO NO MODAL
            var reasonModal = document.getElementById('reasonModal');
            if (reasonModal) {
                reasonModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    // Lê o texto diretamente do atributo 'data-reason-text' do botão
                    var reasonText = button.getAttribute('data-reason-text');

                    var modalBody = reasonModal.querySelector('#rejectionReasonText');

                    // Coloca o texto lido no modal
                    modalBody.textContent = reasonText || 'No detailed reason was provided.';
                });
            }

        });
    </script>
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}